// Manually rewrote @hotwired/stimulus to "/static/cache/stimulus/3.1.0/stimulus.min.js"
import{Controller as t}from"/static/cache/stimulus/3.1.0/stimulus.min.js";let optionSelector="[role='option']:not([aria-disabled])",activeSelector="[aria-selected='true']";export default class e extends t{static targets=["input","hidden","results"];static classes=["selected"];static values={ready:Boolean,submitOnEnter:Boolean,url:String,minLength:Number,delay:{type:Number,default:300}};connect(){this.close(),this.inputTarget.hasAttribute("autocomplete")||this.inputTarget.setAttribute("autocomplete","off"),this.inputTarget.setAttribute("spellcheck","false"),this.mouseDown=!1,this.onInputChange=debounce(this.onInputChange,this.delayValue),this.inputTarget.addEventListener("keydown",this.onKeydown),this.inputTarget.addEventListener("blur",this.onInputBlur),this.inputTarget.addEventListener("input",this.onInputChange),this.resultsTarget.addEventListener("mousedown",this.onResultsMouseDown),this.resultsTarget.addEventListener("click",this.onResultsClick),this.inputTarget.hasAttribute("autofocus")&&this.inputTarget.focus(),this.readyValue=!0}disconnect(){this.hasInputTarget&&(this.inputTarget.removeEventListener("keydown",this.onKeydown),this.inputTarget.removeEventListener("blur",this.onInputBlur),this.inputTarget.removeEventListener("input",this.onInputChange)),this.hasResultsTarget&&(this.resultsTarget.removeEventListener("mousedown",this.onResultsMouseDown),this.resultsTarget.removeEventListener("click",this.onResultsClick))}sibling(t){let e=this.options,s=this.selectedOption,i=e.indexOf(s),n=t?e[i+1]:e[i-1],r=t?e[0]:e[e.length-1];return n||r}select(t){let e=this.selectedOption;e&&(e.removeAttribute("aria-selected"),e.classList.remove(...this.selectedClassesOrDefault)),t.setAttribute("aria-selected","true"),t.classList.add(...this.selectedClassesOrDefault),this.inputTarget.setAttribute("aria-activedescendant",t.id),t.scrollIntoView({behavior:"smooth",block:"nearest"})}onKeydown=t=>{let e=this[`on${t.key}Keydown`];e&&e(t)};onEscapeKeydown=t=>{this.resultsShown&&(this.hideAndRemoveOptions(),t.stopPropagation(),t.preventDefault())};onArrowDownKeydown=t=>{let e=this.sibling(!0);e&&this.select(e),t.preventDefault()};onArrowUpKeydown=t=>{let e=this.sibling(!1);e&&this.select(e),t.preventDefault()};onTabKeydown=t=>{let e=this.selectedOption;e&&this.commit(e)};onEnterKeydown=t=>{let e=this.selectedOption;e&&this.resultsShown&&(this.commit(e),this.hasSubmitOnEnterValue||t.preventDefault())};onInputBlur=()=>{this.mouseDown||this.close()};commit(t){if("true"===t.getAttribute("aria-disabled"))return;if(t instanceof HTMLAnchorElement){t.click(),this.close();return}let e=t.getAttribute("data-autocomplete-label")||t.textContent.trim(),s=t.getAttribute("data-autocomplete-value")||e;this.inputTarget.value=e,this.hasHiddenTarget?(this.hiddenTarget.value=s,this.hiddenTarget.dispatchEvent(new Event("input")),this.hiddenTarget.dispatchEvent(new Event("change"))):this.inputTarget.value=s,this.inputTarget.focus(),this.hideAndRemoveOptions(),this.element.dispatchEvent(new CustomEvent("autocomplete.change",{bubbles:!0,detail:{value:s,textValue:e,selected:t}}))}clear(){this.inputTarget.value="",this.hasHiddenTarget&&(this.hiddenTarget.value="")}onResultsClick=t=>{if(!(t.target instanceof Element))return;let e=t.target.closest(optionSelector);e&&this.commit(e)};onResultsMouseDown=()=>{this.mouseDown=!0,this.resultsTarget.addEventListener("mouseup",()=>{this.mouseDown=!1},{once:!0})};onInputChange=()=>{this.element.removeAttribute("value"),this.hasHiddenTarget&&(this.hiddenTarget.value="");let t=this.inputTarget.value.trim();t&&t.length>=this.minLengthValue?this.fetchResults(t):this.hideAndRemoveOptions()};identifyOptions(){let t=0,e=this.resultsTarget.querySelectorAll(`${optionSelector}:not([id])`);e.forEach(e=>{e.id=`${this.resultsTarget.id}-option-${t++}`})}hideAndRemoveOptions(){this.close(),this.resultsTarget.innerHTML=null}fetchResults=async t=>{if(!this.hasUrlValue)return;let e=this.buildURL(t);try{this.element.dispatchEvent(new CustomEvent("loadstart"));let s=await this.doFetch(e);this.replaceResults(s),this.element.dispatchEvent(new CustomEvent("load")),this.element.dispatchEvent(new CustomEvent("loadend"))}catch(i){throw this.element.dispatchEvent(new CustomEvent("error")),this.element.dispatchEvent(new CustomEvent("loadend")),i}};buildURL(t){let e=new URL(this.urlValue,window.location.href),s=new URLSearchParams(e.search.slice(1));return s.append("q",t),e.search=s.toString(),e.toString()}doFetch=async t=>{let e=await fetch(t,this.optionsForFetch()),s=await e.text();return s};replaceResults(t){this.resultsTarget.innerHTML=t,this.identifyOptions(),this.options?this.open():this.close()}open(){this.resultsShown||(this.resultsShown=!0,this.element.setAttribute("aria-expanded","true"),this.element.dispatchEvent(new CustomEvent("toggle",{detail:{action:"open",inputTarget:this.inputTarget,resultsTarget:this.resultsTarget}})))}close(){this.resultsShown&&(this.resultsShown=!1,this.inputTarget.removeAttribute("aria-activedescendant"),this.element.setAttribute("aria-expanded","false"),this.element.dispatchEvent(new CustomEvent("toggle",{detail:{action:"close",inputTarget:this.inputTarget,resultsTarget:this.resultsTarget}})))}get resultsShown(){return!this.resultsTarget.hidden}set resultsShown(t){this.resultsTarget.hidden=!t}get options(){return Array.from(this.resultsTarget.querySelectorAll(optionSelector))}get selectedOption(){return this.resultsTarget.querySelector("[aria-selected='true']")}get selectedClassesOrDefault(){return this.hasSelectedClass?this.selectedClasses:["active"]}optionsForFetch(){return{headers:{"X-Requested-With":"XMLHttpRequest"}}}};let debounce=(t,e=10)=>{let s=null;return(...i)=>{clearTimeout(s),s=setTimeout(t,e)}};export{e as Autocomplete};
